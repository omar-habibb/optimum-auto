<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Subscribe - Optimum Auto</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      line-height: 1.6;
      background-color: #f9f9f9;
      color: #333;
      padding: 20px;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.05);
    }
    h2, h3 {
      text-align: center;
      margin-bottom: 20px;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
    }
    .car-section {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
    .summary-item {
      margin-bottom: 10px;
    }
    .btn {
      background: black;
      color: white;
      border: none;
      cursor: pointer;
    }
    .btn.back {
      background: #ccc;
      color: black;
    }
    .hidden {
      display: none;
    }
    .summary-cars {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-top: 20px;
}

.summary-car-card {
  background: #f5f5f5;
  border: 1px solid #ddd;
  padding: 15px;
  border-radius: 8px;
  width: calc(50% - 10px); /* Two cards per row */
  box-sizing: border-box;
}

.summary-car-card h4 {
  margin-top: 0;
  margin-bottom: 10px;
}
.summary-car {
  margin-bottom: 20px;
}

.summary-car h4 {
  margin-top: 0;
}

.summary-car-fields {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.summary-car-field {
  flex: 1 1 calc(33% - 10px); /* 3 columns with spacing */
  min-width: 250px;
}
  </style>
</head>
<body>

<div class="container">
  <h2>Subscribe to Optimum Auto</h2>

  <!-- Subscription Form -->
  <form id="subscriptionForm">

    <!-- Step 1: Customer Info -->
    <div id="step1" class="step active">
      <h3>Customer Information</h3>
      <input type="text" name="firstName" placeholder="First Name" required />
      <input type="text" name="lastName" placeholder="Last Name" required />
      <input type="tel" name="phone" placeholder="Phone Number (WhatsApp)" required />
      <input type="text" name="area" placeholder="Area" required />
      <input type="text" name="buildingNumber" placeholder="Building Number" required />
      <input type="number" name="totalCars" min="1" value="1" placeholder="Number of Cars" id="totalCarsInput" required />
      <button type="button" class="btn">Next</button>
    </div>

    <!-- Step 2: Car Details -->
    <div id="step2" class="step hidden">
      <h3>Car Details</h3>
      <div id="carDetailsContainer"></div>
      <button type="button" class="btn back">Back</button>
      <button type="button" class="btn">Next</button>
    </div>

    <!-- Step 3: Summary -->
    <div id="step3" class="step hidden">
      <h3>Summary</h3>
      <div id="summaryContainer"></div>
      <button type="button" class="btn back">Back</button>
      <button type="button" class="btn">Next</button>
    </div>

    <!-- Step 4: Start Date -->
    <div id="step4" class="step hidden">
      <h3>Select Start Date</h3>
      <p>Please choose a Friday.</p>
      <select name="startDate" required>
        <option value="">Select a Friday</option>
      </select>
      <button type="button" class="btn back">Back</button>
      <button type="button" class="btn">Confirm</button>
    </div>

    <!-- Step 5: Confirmation -->
    <div id="step5" class="step hidden text-center">
      <h3>Thank You!</h3>
      <p>Your subscription has been successfully processed.</p>
      <p>Weâ€™ll contact you shortly.</p>
      <button type="button" class="btn" onclick="restartForm()">Start Over</button>
    </div>

  </form>
</div>

<script>
  const steps = document.querySelectorAll(".step");
  let currentStep = 0;
  const formData = JSON.parse(localStorage.getItem("optimumAuto")) || {};

  // Populate form from localStorage
  Object.keys(formData).forEach(key => {
    const el = document.querySelector(`[name='${key}']`);
    if (el) el.value = formData[key];
  });

  const select = document.querySelector("select[name='startDate']");
  generateFridays(select);

  function generateFridays(selectElement) {
    const today = new Date();
    let currentDate = new Date(today);
    const currentDay = today.getDay();
    let daysToAdd = (5 - currentDay + 7) % 7 || 7;
    currentDate.setDate(today.getDate() + daysToAdd);

    for (let i = 0; i < 52; i++) {
      const option = document.createElement("option");
      option.value = currentDate.toISOString().split("T")[0];
      option.textContent = currentDate.toLocaleDateString("en-US", {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric"
      });
      selectElement.appendChild(option);
      currentDate.setDate(currentDate.getDate() + 7);
    }

    if (formData.startDate) selectElement.value = formData.startDate;
  }

  document.querySelectorAll(".btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const direction = btn.textContent === "Next" ? 1 : -1;

    if (direction === 1 && !validateStep(currentStep)) return;

    steps[currentStep].classList.add("hidden");

    if (direction === 1 && currentStep < steps.length - 1) {
      currentStep++;
    } else if (direction === -1 && currentStep > 0) {
      currentStep--;
    }

    steps[currentStep].classList.remove("hidden");

    if (currentStep === 1) generateCarFields();
    if (currentStep === 2) {
      const cars = collectCars();
      generateSummary(cars);
    }
    if (currentStep === 3 && direction === 1) {
  const formData = collectFormData();
  const cars = collectCars(); // Make sure this function is defined
  const { totalPrice, originalPrice } = calculatePrice(cars);

  // Build submission object
  const submission = {
    firstName: formData.firstName,
    lastName: formData.lastName,
    phone: formData.phone,
    area: formData.area,
    buildingNumber: formData.buildingNumber,
    totalCars: formData.totalCars,

    car0Brand: formData["car[0][brand]"] || "",
    car0Model: formData["car[0][model]"] || "",
    car0Color: formData["car[0][color]"] || "",
    car0Plate: formData["car[0][plate]"] || "",
    car0Plan: formData["car[0][plan]"] || "",
    car0AvailableFrom: formData["car[0][availableFrom]"] || "",
    car0DoneBy: formData["car[0][doneBy]"] || "",
    car0Notes: formData["car[0][notes]"] || "",

    car1Brand: formData["car[1][brand]"] || "",
    car1Model: formData["car[1][model]"] || "",
    car1Color: formData["car[1][color]"] || "",
    car1Plate: formData["car[1][plate]"] || "",
    car1Plan: formData["car[1][plan]"] || "",
    car1AvailableFrom: formData["car[1][availableFrom]"] || "",
    car1DoneBy: formData["car[1][doneBy]"] || "",
    car1Notes: formData["car[1][notes]"] || "",

    originalPrice: originalPrice.toFixed(2),
    offerPrice: totalPrice.toFixed(2)
  };

  // Send data to Google Sheets
  sendDataToGoogleSheet(submission);
}

    // Auto-export to CSV when moving to final step
    if (currentStep === 3 && direction === 1) {
      const formData = collectFormData();
      const csvContent = convertToCSV(formData);
      downloadCSV(csvContent, "OptimumAuto_Subscription_" + new Date().toISOString().split("T")[0] + ".csv");
    }
  });
});

function collectFormData() {
  const formData = {};
  const inputs = document.querySelectorAll("input, select, textarea");

  inputs.forEach(input => {
    if (input.name.includes("car[")) {
      const match = input.name.match(/car\$(\d+)\$\.(.+)/);
      if (match) {
        const index = match[1];
        const key = match[2];
        formData[input.name] = input.value;
      }
    } else {
      formData[input.name] = input.value;
    }
  });

  return formData;
}

function convertToCSV(data) {
  const headers = Object.keys(data).filter(key => !key.startsWith("car["));
  const carKeys = ["brand", "model", "color", "plate", "plan", "availableFrom", "doneBy", "notes"];
  let maxCars = 0;

  // Count how many cars exist
  for (const key in data) {
    if (key.startsWith("car[")) {
      const match = key.match(/car\$(\d+)\$\.(.*)/);
      const index = parseInt(match[1]);
      maxCars = Math.max(maxCars, index + 1);
    }
  }

  // Generate header row
  const csvHeaders = [...headers];
  for (let i = 0; i < maxCars; i++) {
    carKeys.forEach(key => {
      csvHeaders.push(`Car ${i + 1} ${toTitleCase(key)}`);
    });
  }

  // Generate data row
  const csvRow = [];
  Object.keys(data).forEach(key => {
    if (!key.startsWith("car[")) {
      csvRow.push(`"${data[key]}"`);
    }
  });

  for (let i = 0; i < maxCars; i++) {
    carKeys.forEach(key => {
      const value = data[`car[${i}][${key}]`] || "";
      csvRow.push(`"${value}"`);
    });
  }

  // Join everything
  return [csvHeaders.join(","), csvRow.join(",")].join("\n");
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.setAttribute("href", url);
  link.setAttribute("download", filename);
  link.style.visibility = "hidden";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

  function validateStep(stepIndex) {
    const step = steps[stepIndex];
    const inputs = step.querySelectorAll("input, select");
    for (const input of inputs) {
      if (!input.checkValidity()) {
        input.reportValidity();
        return false;
      }
    }
    return true;
  }

  function generateCarFields() {
    const container = document.getElementById("carDetailsContainer");
    const totalCars = parseInt(document.querySelector("[name='totalCars']").value) || 1;

    // Save current values before clearing
    const savedCars = collectCars();

    container.innerHTML = "";

    for (let i = 0; i < totalCars; i++) {
      const div = document.createElement("div");
      div.className = "car-section";
      div.innerHTML = `
        <h4>Car ${i+1}</h4>
        <input type="text" name="car[${i}][brand]" placeholder="Brand" value="${savedCars[i]?.brand || ''}" required />
        <input type="text" name="car[${i}][model]" placeholder="Model" value="${savedCars[i]?.model || ''}" required />
        <input type="text" name="car[${i}][color]" placeholder="Color" value="${savedCars[i]?.color || ''}" required />
        <input type="text" name="car[${i}][plate]" placeholder="Plate Number" value="${savedCars[i]?.plate || ''}" required />

        <label>
          Wash Plan:
          <select name="car[${i}][plan]" required>
            <option value="">Select Plan</option>
            <option value="6" ${savedCars[i]?.plan === "6" ? "selected" : ""}>6 Days/Week</option>
            <option value="3" ${savedCars[i]?.plan === "3" ? "selected" : ""}>3 Days/Week</option>
          </select>
        </label>

        <label>
          Available From:
          <select name="car[${i}][availableFrom]">
            ${Array.from({ length: 8 }, (_, i) => i + 1).map(h => `<option>${h}:00 AM</option>`).join("")}
          </select>
        </label>

        <label>
          Need Done By:
          <select name="car[${i}][doneBy]">
            ${Array.from({ length: 7 }, (_, i) => i + 2).map(h => `<option>${h}:30 AM</option>`).join("")}
          </select>
        </label>

        <textarea name="car[${i}][notes]" placeholder="Notes about this car (optional)">${savedCars[i]?.notes || ''}</textarea>
      `;
      container.appendChild(div);
    }

    // Restore previously selected values
    for (let i = 0; i < totalCars; i++) {
      const availableFromInput = container.querySelector(`[name='car[${i}][availableFrom]']`);
      if (availableFromInput && savedCars[i]?.availableFrom) availableFromInput.value = savedCars[i].availableFrom;

      const doneByInput = container.querySelector(`[name='car[${i}][doneBy]']`);
      if (doneByInput && savedCars[i]?.doneBy) doneByInput.value = savedCars[i].doneBy;
    }
  }

  function collectCars() {
    const container = document.getElementById("carDetailsContainer");
    const totalCars = parseInt(document.querySelector("[name='totalCars']").value) || 1;
    const cars = [];

    for (let i = 0; i < totalCars; i++) {
      const brand = container.querySelector(`[name='car[${i}][brand]']`)?.value || "";
      const model = container.querySelector(`[name='car[${i}][model]']`)?.value || "";
      const color = container.querySelector(`[name='car[${i}][color]']`)?.value || "";
      const plate = container.querySelector(`[name='car[${i}][plate]']`)?.value || "";
      const plan = container.querySelector(`[name='car[${i}][plan]']`)?.value || "";
      const availableFrom = container.querySelector(`[name='car[${i}][availableFrom]']`)?.value || "";
      const doneBy = container.querySelector(`[name='car[${i}][doneBy]']`)?.value || "";
      const notes = container.querySelector(`[name='car[${i}][notes]']`)?.value || "";

      if (brand || model || color || plate || plan) {
        cars.push({ brand, model, color, plate, plan, availableFrom, doneBy, notes });
      }
    }

    return cars;
  }

  function generateSummary(cars) {
  const container = document.getElementById("summaryContainer");
  container.innerHTML = "<h4>Your Selection</h4>";

  // Show customer info
  const fields = ["firstName", "lastName", "phone", "area", "buildingNumber", "totalCars"];
  fields.forEach(name => {
    const val = document.querySelector(`[name='${name}']`)?.value || "";
    if (val) {
      container.innerHTML += `<div class="summary-item"><strong>${toTitleCase(name)}:</strong> ${val}</div>`;
    }
  });

  // Show car details in stacked layout with inline fields
if (cars.length > 0) {
  container.innerHTML += `<h4>Car Details</h4>`;
  
  cars.forEach((car, idx) => {
    container.innerHTML += `
      <div class="summary-car">
        <h4>Car ${idx + 1}</h4>
        <div class="summary-car-fields">`;

    // Loop through car properties
    for (const key in car) {
      if (car[key]) {
        container.innerHTML += `
          <div class="summary-car-field">
            <strong>${toTitleCase(key)}:</strong> ${car[key]}
          </div>`;
      }
    }

    container.innerHTML += `</div></div>`;
  });
}

  // Calculate prices safely
  const { totalPrice, originalPrice } = calculatePrice(cars);
  const saved = (originalPrice - totalPrice).toFixed(2);

  // Show price breakdown
  container.innerHTML += `
    <hr>
    <div class="summary-item"><strong>Original Price:</strong> EGP ${(originalPrice || 0).toFixed(2)}</div>
    <div class="summary-item"><strong>Offer Price:</strong> EGP ${(totalPrice || 0).toFixed(2)}</div>
    <div class="summary-item"><strong>You Save:</strong> EGP ${saved}</div>
  `;
}

function toTitleCase(str) {
  return str.replace(/\w+/g, w => w[0].toUpperCase() + w.slice(1));
}

  function calculatePrice(cars = []) {
  let totalPrice = 0;
  let originalPrice = 0;

  const sixDayCars = cars.filter(c => c.plan === "6");
  const threeDayCars = cars.filter(c => c.plan === "3");

  // Handle 6-day washes
  if (sixDayCars.length === 1) {
    totalPrice += 800;
    originalPrice += 800;
  } else if (sixDayCars.length === 2) {
    totalPrice += 750 * 2;
    originalPrice += 800 * 2;
  } else if (sixDayCars.length >= 3) {
    totalPrice += 700 * sixDayCars.length;
    originalPrice += 800 * sixDayCars.length;
  }

  // Handle 3-day washes
  if (threeDayCars.length === 1) {
    totalPrice += 450;
    originalPrice += 450;
  } else if (threeDayCars.length === 2) {
    totalPrice += 400 * 2;
    originalPrice += 450 * 2;
  } else if (threeDayCars.length >= 3) {
    totalPrice += 350 * threeDayCars.length;
    originalPrice += 450 * threeDayCars.length;
  }

  return {
    totalPrice: parseFloat(totalPrice.toFixed(2)),
    originalPrice: parseFloat(originalPrice.toFixed(2))
  };
}

  function saveData() {
    const data = {};
    const inputs = document.querySelectorAll("input, select, textarea");

    inputs.forEach(input => {
      if (input.name.includes("car[")) {
        const match = input.name.match(/car\$(\d+)\$\.(.+)/);
        if (match) {
          const index = parseInt(match[1]);
          const key = match[2];
          if (!data.car) data.car = [];
          if (!data.car[index]) data.car[index] = {};
          data.car[index][key] = input.value;
        }
      } else {
        data[input.name] = input.value;
      }
    });

    localStorage.setItem("optimumAuto", JSON.stringify(data));
  }

  function toTitleCase(str) {
    return str.replace(/\w+/g, w => w[0].toUpperCase() + w.slice(1));
  }

  function restartForm() {
    localStorage.removeItem("optimumAuto");
    location.reload();
  }

  async function sendDataToGoogleSheet(data) {
  const url = "https://script.google.com/macros/s/AKfycbwgx_nU5z4A9mlBIPB1BxcG4rEywORzVNEBsvqc9AWayT8qHOzLcQBfefGmszKPPwQ/exec"; // Replace with your web app URL

  try {
    await fetch(url, {
      method: "POST",
      mode: "cors",
      body: JSON.stringify(data),
      headers: {
        "Content-Type": "application/json"
      }
    });
  } catch (error) {
    console.error("Error sending data:", error);
  }
  } 

async function sendDataToGoogleSheet(data) {
  const url = "YOUR_GOOGLE_SCRIPT_URL"; // Replace with real URL

  try {
    const response = await fetch(url, {
      method: "POST",
      mode: "no-cors", // Important: avoids CORS issues during dev
      body: JSON.stringify(data),
      headers: {
        "Content-Type": "application/json"
      }
    });

    if (!response.ok) {
      throw new Error("Failed to send data");
    }

    const result = await response.json();
    console.log("Data sent successfully:", result);
  } catch (error) {
    console.error("Error sending data:", error);
  }
}
</script>

</body>
</html>